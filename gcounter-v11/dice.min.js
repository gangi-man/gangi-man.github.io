function make_dice_counter(){function n(n){for(;n;){if("BLOCKQUOTE"==n.tagName)return n
n=n.nextElementSibling}return null}function t(n,t,e){var i=null,o=[]
if(t.innerHTML.split(/<br>/i).forEach(function(n,t,e){n.match(/<font\s+color="#ff0000"\s*>/i)&&(i=n,n=n.replace(/<font/i,'<span class="faces"><font'),n=n.replace(/<\/font>/i,"</font></span>")),o.push(n)}),i){t.innerHTML=o.join("<br>")
var r=RegExp(/dice(\d+)d(\d+)([-+]\d+)?=/i),c=r.exec(i)
if(!c)return null
var l=c[1],u=c[2],a=0,s=""
c[3]&&(a=Number(c[3]),a<0&&(s=""+a),a>0&&(s="+"+a))
var d="dice"+l+"d"+u+s,f=/<font\s+color="#ff0000">\s*((\d+\s+)+)\((\d+)\)<\/font>/.exec(i)
if(!f)return console.log("---------something wrong ---"+n+"\n"+i),null
var g=Number(f[3]),_=f[1].replace(/\s+$/,"").split(/\s+/)
return _.forEach(function(n,t,e){e[t]=Number(n)}),{dnum:l,dmax:u,dadd:a,kind:d,id:Number(n),input:e,bloq:t,faces:_,sum:g}}}function e(n){var t=n.bloq.innerHTML
t=t.replace(/&gt;/gi,">"),t=t.replace(/<br>/gi,"\n"),t=t.replace(/<[^>]*>/g,""),console.log("id:"+n.id+" "+n.kind+" score:"+n.ginga_score+"\n"+n.ginga_arr+"\n"+t)}function i(){if(!h){var e=document.getElementsByTagName("input")
h=[]
for(var i=0;i<e.length;i++){var r=/delcheck(\d+)/.exec(e[i].getAttribute("id"))
if(r){var c=n(e[i])
if(c){var l=t(r[1],c,e[i])
l&&h.push(l)}}}h.forEach(function(n,t,e){o(n)}),h.length>0&&(b=h[0].sum)}}function o(n){function t(n){var t=0
return n.forEach(function(e,i,o){n[i]==r[i]&&t++}),n.length>=4&&"GA"==n[0]&&"NN"==n[1]&&"GA"==n[2]&&"NN"==n[3]&&(t+=4),n.length>=7&&"GI"==n[4]&&"GI"==n[5]&&"NN"==n[6]&&(t+=3),n.length>=12&&"GI"==n[7]&&"NN"==n[8]&&"GA"==n[9]&&"MA"==n[10]&&"NN"==n[11]&&(t+=5),t}function e(n){var t=""
return n.forEach(function(e,i,c){t+=n[i]==r[i]?'<font color="#191970">'+o[n[i]]+"</font> ":'<font color="#4682b4">'+o[n[i]]+"</font> "}),t}if(!n.ginga_html){for(var i=["GA","NN","GI","MA","**"],o={GA:"&#12460;",NN:"&#12531;",GI:"&#12462;",MA:"&#12510;","**":"&#65290;"},r=["GA","NN","GA","NN","GI","GI","NN","GI","NN","GA","MA","NN"],c=0,l=[],u=[],a={},s=n.sum;s>0;)l=[s%10].concat(l),s=Math.floor(s/10)
l=n.faces.concat(l),l.forEach(function(n,t,e){n in a||(a[n]=i[c],c<4&&c++),u.push(a[n])}),n.ginga_html=e(u),n.ginga_score=t(u)}}function r(){function n(){var n=localStorage.getItem("__ginga_counter__.sort_mode")
return n}function t(n){localStorage.setItem("__ginga_counter__.sort_mode",n)}var e={"no+":function(n,t){return t.id-n.id},"no-":function(n,t){return n.id-t.id},"sum+":function(n,t){return t.sum-n.sum},"sum-":function(n,t){return n.sum-t.sum},"gng+":function(n,t){return t.ginga_score-n.ginga_score},"gng-":function(n,t){return n.ginga_score-t.ginga_score}}
return n()||t("no-"),{get_func:function(i){return i||(i=n()),t(i),e[i]},get_mode:n}}function c(){function n(){return Number(localStorage.getItem("__ginga_counter__.descr_show_mode"))}function t(n){localStorage.setItem("__ginga_counter__.descr_show_mode",Number(n))}return{get:n,set:t}}function l(n){if(!L){var t=v("_ginga_frame_")
t&&document.body.removeChild(t)
var e=L=document.createElement("IFRAME")
e.MaxHeight=Math.floor(.8*window.innerHeight),e.setAttribute("id","_ginga_frame_"),e.style.position="fixed",e.style.top="0px",e.style.right="0px",e.style.width="380px",e.style.height=e.MaxHeight+"px",e.style.backgroundColor="#e9dfe5",document.body.appendChild(e),setTimeout(function(){u(),d(),a(),s(h,null)},500)}}function u(){function n(){var n=localStorage.getItem("__ginga_counter__.list_open")
return!n||Number(n)}function t(t){var e=n()
e?(L.style.height=H.clientHeight+"px",G.hide()):L.style.height=L.MaxHeight+"px",localStorage.setItem("__ginga_counter__.list_open",Number(!e))}function e(n){p("toggle_descr")}function i(n,t){var i=y("enableGinga")
"gng+"!=n&&"gng-"!=n||i.checked||(i.checked=!0,e(null)),s(h,N.get_func(n))}function o(n){b=Number(y("input_ginga").value),s(h,N.get_func())}if(!H){M=v("_ginga_frame_").contentDocument
var r=H=M.createElement("DIV")
r.innerHTML+="<button id='sortNoBtn_'>&#21476;&#38918;</button>",r.innerHTML+="<button id='sortNoBtn'>&#26032;&#38918;</button>",r.innerHTML+="<button id='sortSumBtn'>&#22810;&#38918;</button>",r.innerHTML+="<button id='sortSumBtn_'>&#23569;&#38918;</button>",r.innerHTML+="<button id='sortGngBtn'>&#12462;&#38918;+</button>",r.innerHTML+="<button id='sortGngBtn_'>&#12462;&#38918;-</button>"
var c=E.get()?"checked":""
r.innerHTML+="<input id='enableGinga' type='checkbox' "+c+">",r.innerHTML+="<input id='input_ginga' size='8' value='"+b+"'/>",r.innerHTML+="<button id='opclBtn'>open/close</button>",r.style.position="fixed",r.style.top="0px",M.body.appendChild(r),y("sortNoBtn_").addEventListener("click",i.bind(null,"no-")),y("sortNoBtn").addEventListener("click",i.bind(null,"no+")),y("sortSumBtn").addEventListener("click",i.bind(null,"sum+")),y("sortSumBtn_").addEventListener("click",i.bind(null,"sum-")),y("sortGngBtn").addEventListener("click",i.bind(null,"gng+")),y("sortGngBtn_").addEventListener("click",i.bind(null,"gng-")),y("enableGinga").addEventListener("change",e),y("opclBtn").addEventListener("click",t),y("input_ginga").addEventListener("input",o),n()||(L.style.height=H.clientHeight+"px")}}function a(){if(x)for(;x.firstChild;)x.removeChild(x.firstChild)
else{var n=M,t=x=n.createElement("DIV")
t.style.position="fixed",t.style.overflow="scroll",t.style.top=H.clientHeight+"px",t.style.width="95%",t.style.height=L.MaxHeight-H.clientHeight+"px",M.body.appendChild(t)}}function s(n,t){function e(n){var t=n.input.getBoundingClientRect().top+window.pageYOffset
window.scrollTo(0,t)}function i(n){G.update(n.target.dice.bloq.innerHTML)}a(),t||(t=N.get_func()),n=n.sort(t),n.forEach(function(n,t,o){var r=M.createElement("DIV")
r.innerHTML="id:"+n.id+" "+n.kind+" sum:"+n.sum+" GP:"+n.ginga_score,r.addEventListener("click",e.bind(null,n)),r.dice=n,r.addEventListener("mouseover",i),n.sum<b?r.style.backgroundColor="#8989ff":n.sum==b?r.style.backgroundColor="#89ffc4":r.style.backgroundColor="#ff8989",x.appendChild(r)})}function d(){G||(G=document.createElement("span"),G.style.position="fixed",G.style.bottom="0px",G.style.right="0px",G.style.backgroundColor="#f5deb3",G.style.display="none",G.innerHTML="",G.update=function(n){G.style.display="",G.innerHTML=n},G.hide=function(){G.style.display="none"},setTimeout(function(){document.body.appendChild(G)},500))}function f(n){var t=""
n.bloq.innerHTML.split(/<br>/i).forEach(function(e,i,o){t+=e,e.match(/<font\s+color/i)&&e.match(/"#ff0000"/i)&&(t+='<span class="ginga_descr">',t+='<br><span style="visibility:hidden;">'+n.kind+"=</span>",t+='<span class="faces">'+n.ginga_html+"</span>",t+=' <font color="#4b0082">(GP:'+n.ginga_score+")</font></span>"),t+="<br>"}),n.bloq.innerHTML=t
var e=n.bloq.getElementsByClassName("faces")
if(!T){var i=Math.floor(100*e[0].offsetWidth/e[1].offsetWidth)
i<20&&(i=20),T=i+"%"}e[1].style.fontSize=T}function g(){var n=v("ftbl"),t=v("ufm")
"absolute"==n.style.position&&(n.style.top=t.offsetTop+"px")}function _(n){for(var t=document.getElementsByClassName("ginga_descr"),e=0;e<t.length;e++)t[e].style.display=n?"":"none"
g()}function m(){h.forEach(function(n,t,i){e(n)})}function p(n){if("init"==n)h=null,i(),l(),h.forEach(function(n,t,e){f(n)}),_(E.get())
else if("cls"==n)s(h,null)
else if("toggle_descr"==n){var t=!E.get()
E.set(t),_(t)}else"dump"==n?m():console.log("DISPATCH ERROR"+n)}var h=null,b=0,v=function(n){return document.getElementById(n)},y=function(n){return M.getElementById(n)},N=r(),E=c(),L=null,M=null,x=null,H=null,G=null,T=null
return p}"undefined"==typeof __dice_counter__&&(__dice_counter__=make_dice_counter(),__dice_counter__("init"))
