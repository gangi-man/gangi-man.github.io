function __imo_dice__(){if("undefined"!=typeof __imo_dice_exports__)return __imo_dice_exports__;let e={};function t(e){function t(){return"undefined"!=typeof window}function n(t){if(e.length-t<2||!function(t){if(255!=e[t])return!1;let n=e[t+1];return 1==n||2<=n&&n<=78||192==n||193==n||194==n||195==n||196==n||197==n||198==n||199==n||200==n||201==n||202==n||203==n||204==n||205==n||206==n||207==n||208<=n&&n<=215||216==n||217==n||218==n||219==n||220==n||221==n||222==n||223==n||224<=n&&n<=239||240<=n&&n<=253||254==n}(t))throw new Error("wrong_image_array");return 218==e[t+1]?function(t){if(255==e[t]&&218==e[t+1])return e.length-t-2;throw new Error("wrong_image_array")}(t):function(e){return 215==e||216==e||217==e||1==e}(e[t+1])?0:256*e[t+2]+e[t+3]}function r(t){let r=t+n(t)+2;return e.slice(t,r)}function l(){if(o.length>0)return o;let t=0;for(;t<e.length;){let e=r(t);t+=e.length,o.push(e)}if(o.length<=0)throw new Error("wrong_image_array");return o}function i(e){return 255==e[0]&&254==e[1]}let o=[];return l(),{get_image_array:function(){return e},get_all_segments:l,get_comment:function(){for(let n=0;n<o.length;n++)if(i(o[n]))return e=o[n],t()?new TextDecoder("utf-8").decode(e.slice(4)):new Buffer(e.slice(4)).toString("utf-8");var e;return null},set_comment:function(n){let r=[];for(let e=0;e<o.length;e++)i(o[e])||r.push(o[e]);if(n){let e=function(e){if(e.length>65533)throw new Error("Too long comment");let t=new Uint8Array([255,254,0,0]),n=e.length+2;t[2]=Math.floor(n/256),t[3]=n%256;let r=new Uint8Array(t.length+e.length);return r.set(t),r.set(e,t.length),r}(function(e){if(t())return new TextEncoder("utf-8").encode(e);{let t=Buffer.from(e);return new Uint8Array(t)}}(n));r.splice(r.length-1,0,e)}o=r,e=function(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n].length;let n=new Uint8Array(t),r=0;for(let t=0;t<e.length;t++)n.set(e[t],r),r+=e[t].length;return n}(r)}}}function n(){function e(e){const t=/<\s*font\s+color="#ff0000"\s*>\s*([^<]*)<\/\s*font\s*>/i;let n=null;if(e.innerHTML.split(/<br>/i).forEach(function(e,r,l){e.match(t)&&(n=e)}),!n)return null;let r=n.match(/dice(\d+)d(\d+)/);if(!r)return null;let l=Number(r[1]),i=Number(r[2]),o=0;if((r=n.match(/\d\+(\d+)=/))&&(o=Number(r[1])),!(r=n.match(t)))return null;let u=r[1];const c=/\s*\(\s*(\d+)\s*\)/;if(!(r=u.match(c)))return null;let f=Number(r[1]),a=[];return(u=u.replace(c,"")).split(/\s+/).forEach(function(e){a.push(Number(e))}),{dice_number:l,dice_value_max:i,dice_addition:o,eyes:a,sum:f}}function t(e,t){return new Promise(function(t,n){let r=new XMLHttpRequest;r.responseType="arraybuffer",r.open("GET",e),r.onload=function(e){let n=r.response;t(new Uint8Array(n))},r.onerror=function(e){n(e)},r.send(null)})}return{extract:function(){function t(e){for(;e;){if("BLOCKQUOTE"==e.tagName)return e;e=e.nextElementSibling}return null}let n=[],r=document.getElementsByTagName("input");for(let l=0;l<r.length;l++){if(!/delcheck(\d+)/.exec(r[l].getAttribute("id")))continue;let i=t(r[l]);i&&n.push({element:i,dice:e(i)})}return n},extract_image:function(e=!0){let n=document.getElementsByTagName("a");for(let r=0;r<n.length;r++){let l=n[r];if(l.innerHTML.match(/\d+\.jpe?g/i)&&(!e||l.href.match(/^https?:\/\/[^.]+\.2chan.net\//i)))return t(l.href)}throw new Error("no_image_in_html_error")}}}function r(e){function t(e){let t={};return(e=(e=(e=e.replace(/<br>/gi,"\n")).replace(/;/g,";\n")).replace(/,/g,",\n")).split(/\r?\n/).forEach(function(e,r,l){let i=null;(i=e.match(/^\s*(#[#\d]+)[^,;]*[,;]\s*$/))&&function(e){let t=[],n=null;for(;n=e.match(/#(\d+)/);)t.push(Number(n[1])),e=e.replace(/#\d+/,"");return t}(i[1]).forEach(function(e){if(e<0||e>10||isNaN(e))throw new Error("pip_value_error");let r=n(i[0]);if(0==e)for(let e=1;e<=10;e++)t[e]=r;else t[e]=r})}),t}function n(e){let t=e.match(/\s*[#\d]+\s+([^;,]*)([;,])/);if(!t)return null;let n=t[1].replace(/\s*$/,""),r=";"===t[2],l=n.split(/\s+/);return{name:l.shift(),newline:r,pip_value_list:function(e){let t=[];for(let n=0;n<e.length;n++){let r=e[n].split(/:/);if(2!=r.length)throw new Error("pip_value_error");let l=Number(r[0]);if(l<=0||Number.isNaN(l))throw new Error("pip_value_error");t.push({pip:Number(r[0]),value:r[1]})}let n={};for(let e=0;e<t.length;e++){if(t[e].pip in n)throw new Error("pip_value_error");n[t[e].pip]=1}return t.sort((e,t)=>e.pip-t.pip)}(l)}}let r={};return e&&(r=t(e)),{rules:function(){return!r||Object.keys(r).length<=0?null:r},parse:t,parse_rule_line:n,apply:function(e){function t(e,t,n,r=!1,l=!1){return{disp:e,name:t,value:n,is_pip_value:l,delimiter:r?"<br>":" "}}function n(e,t){for(let n=0;n<e.length;n++){let r=e[n];if(t<=r.pip)return r.value}return t}if(!r||!e)return null;let l=[],i=e.eyes;for(let e=0;e<i.length;e++){let o=r[e+1];if(void 0===o){l.push(t("d"+(e+1)+":"+i[e],"d"+(e+1),i[e]));continue}let u="",c="";o.name.length&&"#"!=o.name[0]&&(u=o.name+":",c=o.name),o.pip_value_list.length>0?l.push(t(u+n(o.pip_value_list,i[e]),c,i[e],o.newline,!0)):l.push(t(u+i[e],c,i[e],o.newline,!1))}return l},is_valid:function(){return!!r&&Object.keys(r).length>0}}}return e.jpeg_operations_constructor=t,e.rpg_dice_html_extract=n,e.rpg_dice_rule=r,e.rpg_dice_display=function(){const e=99999,l="#ffffee",i="#841a75",o=14,u="#000000",c=250,f=270;let a=null,s=null,h=null;function p(e){return document.getElementById(e)}function d(e){if(!a){try{!function(e){if(a)return;let n=r(t(e).get_comment());n.rules()&&(a=n)}(e)}catch(e){}!function(){if(a)return;let e=n().extract();for(let t=0;t<e.length;t++){let n=e[t].element;try{let e=r(n.innerHTML);if(e.rules())return void(a=e)}catch(e){}}}()}}function m(){let e=p("ftbl"),t=p("ufm");e&&t&&(e.style.top=t.offsetTop+"px")}function _(e,t){let n=a.apply(t),r=n.map(e=>e.disp+e.delimiter).join("");parent.APP=n;let l=document.createElement("div");l.className="imodice_show",l.innerHTML=`<font color='${i}' size='-1'>${r}</font>`;let o=[],u=[],c=[];for(let e=0;e<n.length;e++)n[e].is_pip_value?c.push(n[e].disp):(o.push(n[e].name),u.push(n[e].value));l.onmouseover=function(){w(t.dice_value_max,o,u,c)},e.appendChild(l)}function g(){if(!a)throw new Error("no rule found");let e=n().extract();for(let t=0;t<e.length;t++){let n=e[t].element;if(n=n,parent.ELEM=n,n.getElementsByClassName("imodice_show").length>0)continue;let r=e[t].dice;r&&_(n,r)}var t}function y(t){h||((h=document.createElement("div")).style.zIndex=e,h.style.position="fixed",h.style.top=0,h.style.right=0,h.style.backgroundColor="red",h.onclick=(()=>h.style.display="none"),document.body.appendChild(h));let n="IMODICE ERROR!:"+t.message;console.log(n),h.innerHTML=n,h.style.display=""}function w(t,n,r,a){function h(e,n){return{x:e/t*v*Math.cos(n)+b,y:-e/t*v*Math.sin(n)+M}}function d(e,t,n,r){let l=n?`${n}:`:"";l+=r,E.fillStyle=i,E.font=`${o}px Arial`;let u=E.measureText(l).width,f=o;e=e<b?e:e+f,t=t<M?t:t+u,e=Math.max(0,e-u/2),e=Math.min(e,c-u),t=Math.max(f,t),t=Math.min(t,c-f),E.fillText(l,e,t)}if(r.length<3)return void x();let m,_,g=r.reduce((e,t)=>e+t)/(t*r.length);g=.5*(g-.5)/.4+.5,g=Math.min(1,g),(g=Math.max(0,g))<.5?(m=Math.floor(2*g*255),_=255):(m=255,_=Math.floor(255*(1-2*(g-.5))));let y=`rgb(${m}, 0, ${_})`;s||((s=document.createElement("canvas")).id="imodice_chart",s.width=c,s.height=f,s.style.zIndex=e,s.style.position="fixed",s.style.top=0,s.style.right=0,s.onclick=(()=>x()),document.body.appendChild(s));let w=p("imodice_chart");w.style.display="none";let E=s.getContext("2d"),v=.9*c/2,b=c/2,M=b,T=r.length;!function(){let e=Math.PI/2;h(t,e),E.fillStyle=l,E.fillRect(0,0,c,f)}(),E.fillStyle=y;let N=Math.PI/2,P=h(r[0],N);E.beginPath(),E.moveTo(P.x,P.y);for(let e=1;e<T;e++)N-=2*Math.PI/T,P=h(r[e],N),E.lineTo(P.x,P.y);E.closePath(),E.fill(),function(e){let l=Math.PI/2;for(let i=0;i<e;i++){let o=h(t,l);E.strokeStyle=u,E.beginPath(),E.moveTo(b,M),E.lineTo(o.x,o.y),E.closePath(),E.stroke(),l-=2*Math.PI/e,d(o.x,o.y,n[i],r[i])}for(let e=1;e<=4;e++){let t=v*e/4;E.strokeStyle=u,E.beginPath(),E.arc(b,M,t,0,2*Math.PI),E.closePath(),E.stroke()}}(T),function(){if(a.length<=0)return;let e=a.reduce((e,t)=>e+" "+t);E.fillStyle=i,E.font=`${o}px Arial`,E.fillText(e,4,f-4,c-8)}(),w.style.display=""}function x(){s&&(p("imodice_chart").style.display="none")}return{show:function(e=!0){a?(g(),m()):n().extract_image(e).then(d).then(g).then(m).catch(y)},hide:function(){},show_chart:w,hide_chart:x}},__imo_dice_exports__=e,e}